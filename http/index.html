<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Code your own SQL!</title>

    <link rel="stylesheet" href="http://x.scraperwiki.com/vendor/style/bootstrap.min.css">
    <link rel="stylesheet" href="http://x.scraperwiki.com/style/scraperwiki.css">
    <style type="text/css">
      body {
	padding: 20px;
	height: 100%;
      }
      html {
	height: 100%;
      }
      #editorPanel { 
	position: absolute;
	bottom: 20px;
        top: 20px;
	right: 51%;
	left: 20px;
      }
      #outputPanel { 
	position: absolute;
	bottom: 30px;
        top: 20px;
	left: 51%;
	right: 20px;
      }
      #editor {
	width: 100%;
	height: 100%;
      }
      #schema {
	width: 100%;
      }
      #table {
	width: 100%;
	height: 100%;
      }
      #table {
        overflow: auto;
	display: block;
      }
      #runPanel {
	position: absolute;
	width: 10%;
	text-align: center;
	bottom: 75%;
	left: 45%;
	right: 45%;
	display: none;
      }
      .inserter {
	cursor: pointer
      }
      p.loading { 
	display: none;
	margin-top: 100px;
	padding-top: 50px;
	text-align: center;
	background: transparent url('tool-loader.gif') center top no-repeat;
	color: #666;
	font-size: 20px;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="jquery.hotkeys-0.7.9.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>

    <script src="http://x.scraperwiki.com/vendor/js/bootstrap.min.js"></script>
    <script src="https://x.scraperwiki.com/js/scraperwiki.js"></script>
    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
  </head>
  <body>

   <div id="editorPanel">
     <div id="editor"></div>
   </div>

   <div id="runPanel">
     <button type="button" class="btn btn-primary" id="run" title="Ctrl+Q">
     Query <i class="icon-arrow-right icon-white"></i>
     </button>
   </div>

<!--   <div id="helpPanel">
     <div class="btn-group dropup" id="help">
	<a class="btn btn-info dropdown-toggle" data-toggle="dropdown" href="#">
	  Help
	  <span class="caret"></span>
	</a>
	<ul class="dropdown-menu pull-right">
	  <li><a href="http://zetcode.com/db/sqlite/select/" target="_blank">Basic SQL tutorial</a></li>
	  <li class="divider"></li>
	  <li><a href="http://www.sqlite.org/lang_corefunc.html" target="_blank">SQLite core functions</a></li>
	  <li><a href="http://www.sqlite.org/lang_datefunc.html" target="_blank">SQLite date/time functions</a></li>
	  <li><a href="http://www.sqlite.org/lang_aggfunc.html" target="_blank">SQLite aggregate functions</a></li>
	</ul>
      </div>
     </div> -->

   <div id="outputPanel">
     <table class="table table-striped" id="table"> </div>
     <div id="problem"></div>
     <div id="schema"><h1>Schema</h1></div>
   </div>


   <script>
    var editor

    var run = function() {
      $(".alert").remove()
      $('#run').addClass('loading').attr('disabled', true)
      var code = editor.getValue()
      var cmd = "mkdir -p code; cat >code/query.sql.$$.new <<ENDOFSCRAPER\n" + code + "\nENDOFSCRAPER\n"
      cmd = cmd + "mv code/query.sql.$$.new code/query.sql"
      scraperwiki.exec(cmd, function () {
	scraperwiki.sql(code, function (response) {
	    if (!response || response.length < 1) {
	      err("No data", "The table is empty") 
            } else {
              var $head = $('<thead><tr></tr></thead>')
	      $.each(response[0], function (key, value) {
                $('tr', $head).append('<th>' + key + '</th>')
	      })
             
	      $('#problem').hide()
	      $('#schema').hide()
	      $('#table').empty()
              $('#table').append($head)

	      var $tbody = $('<tbody></tbody>')
	      $.each(response, function (ix, table) {
                var $row = $('<tr></tr>')
		$.each(table, function (key, value) {
                  $row.append('<td>' + value + '</td>')
		})
                $tbody.append($row)
	      })
              $('#table').append($tbody)
            }
	    $('#run').removeClass('loading').attr('disabled', false)
	}, function (response) {
            err("Error in SQL", jQuery.parseJSON(response.responseText))
	    $('#run').removeClass('loading').attr('disabled', false)
	    $('#schema').show()
	})
      }, function (jqXHR, textStatus, errorThrown) { 
	err("Error saving query", textStatus) 
	$('#run').removeClass('loading').attr('disabled', false)
      })
    }

    var err = function(head, body) {
      $('#table').empty()
      $('#problem').html('<h1>' + head + '</h1><p>' + body + '</p>')
      $('#problem').show()
    }

    $(document).ready(function() {
      editor = ace.edit("editor")
      editor.renderer.setShowGutter(false)
      editor.setTheme("ace/theme/clouds")
      editor.getSession().setMode("ace/mode/sql")
      editor.renderer.setPadding(40) 
      scraperwiki.exec('mkdir -p code; touch code/query.sql; cat code/query.sql', function(data) {
	var firstTime = false
	data = data.replace(/\s\s*$/, '')
	if (data == "") {
	  // data = "select * from "
	  firstTime = true
	}
	editor.setValue(data)
	editor.clearSelection()
	editor.focus()
	if (!firstTime) {
	  run()
	}
      })

      $('#run').on('click', run)
      $(document).bind('keydown', 'ctrl+q', run)
      editor.on('change', _.debounce(run, 1000))

      scraperwiki.sql.meta(function (response) {
	$.each(response.table, function (table_name, table) {
	  var html = '<h2 class="inserter">' + table_name + '</h2> <ul class="inline">' + 
	    $.map(table.columnNames, function(col) { return '<li class="inserter">' + col + '</li>' }).join('') 
	    + "</ul>"
	  var $table = $(html)
	  $('#schema').append($table)
	})
	var lastCursorPosition = -1
	editor.on('change', function() {
	  lastCursorPosition = -1
	})
	$('.inserter').click(function() {
	  if (JSON.stringify(lastCursorPosition) == JSON.stringify(editor.getCursorPosition())) {
	    editor.insert(', ')
	  }
	  editor.insert($(this).text())
	  editor.focus()
	  lastCursorPosition = editor.getCursorPosition()
	})
      }, function (jqXHR, textStatus, errorThrown) { err("Error getting schema", textStatus) } )
    })
    </script>

  </body>
</html>


