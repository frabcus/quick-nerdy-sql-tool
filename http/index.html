<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Code your own SQL!</title>
    <link rel="stylesheet" href="vendor/css/bootstrap.min.css">
    <link rel="stylesheet" href="vendor/css/scraperstrap.css">
    <style type="text/css">
      body {
	padding: 20px;
	height: 100%;
      }
      html {
	height: 100%;
      }
      #editorPanel { 
	width: 45%;
	float: left;
	height: 100%;
      }
      #outputPanel { 
	width: 45%;
	float: right;
	height: 100%;
      }
      #editor, #output {
	width: 100%;
	height: 80%;
      }
      #runPanel {
	position: absolute;
	width: 10%;
	text-align: center;
	bottom: 50%;
	left: 45%;
	right: 45%;
      }
      #metaPanel {
	position: absolute;
	bottom: 20px;
      }
      .inserter {
	cursor: pointer
      }
      p.loading { 
	display: none;
	margin-top: 100px;
	padding-top: 50px;
	text-align: center;
	background: transparent url('tool-loader.gif') center top no-repeat;
	color: #666;
	font-size: 20px;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="https://x.scraperwiki.com/js/scraperwiki.js"></script>
    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="jquery.hotkeys-0.7.9.min.js"></script>
    <script src="vendor/js/bootstrap.min.js"></script>
  </head>
  <body>

   <div id="editorPanel">
     <div id="editor"></div>
   </div>

   <div id="runPanel">
     <form id="tw" action="#" method="POST" enctype="multipart/form-data">
	<input type="button" class="btn btn-primary" value="Query &gt;" id="run" title="Ctrl+Q">
	<br>
     </form>
   </div>

   <div id="outputPanel">
     <div id="output"></div>
   </div>

   <div id="metaPanel">
     <div id="meta"> </div>
   </div>

   <script>
   $(document).ready(function() {
        var editor = ace.edit("editor")
        scraperwiki.exec('mkdir -p code; touch code/query.sql; cat code/query.sql', function(data) {
	  data = data.replace(/\s\s*$/, '')
	  if (data == "") {
	    data = "select * from "
	  }
          editor.setValue(data)
          editor.setTheme("ace/theme/monokai")
          editor.getSession().setMode("ace/mode/sql")
          editor.clearSelection()
          editor.focus()
        })

        var output = ace.edit("output")
        output.setTheme("ace/theme/monokai")
	output.setReadOnly(true)

	var run = function() {
          $('#run').addClass('loading').attr('disabled', true)
          var code = editor.getValue()
          var cmd = "mkdir -p code; cat >code/query.sql.$$.new <<ENDOFSCRAPER\n" + code + "\nENDOFSCRAPER\n"
          cmd = cmd + "mv code/query.sql.$$.new code/query.sql"
	  scraperwiki.exec(cmd, function () {
	    scraperwiki.sql(code, function (response) {
		output.getSession().setMode("ace/mode/json")
		output.setValue(JSON.stringify(response, null, 4))
		output.clearSelection()
		$('#run').removeClass('loading').attr('disabled', false)
	    }, function (response) {
		output.getSession().setMode("ace/mode/json")
		output.setValue(JSON.stringify(response, null, 4))
		output.clearSelection()
		$('#run').removeClass('loading').attr('disabled', false)
	    })
	  }, function (jqXHR, textStatus, errorThrown) { 
	    scraperwiki.alert("Error saving query:", textStatus) 
	    $('#run').removeClass('loading').attr('disabled', false)
  	  })
        }
        $('#run').on('click', run)
 	$(document).bind('keydown', 'ctrl+q', run)

	scraperwiki.sql.meta(function (response) {
	  $.each(response.table, function (table_name, table) {
	    // either "table" or "view" I think
	    var extra_class = ''
	    if (table.type != "table") {
	      extra_class = 'badge-info'
	    }
	    var html = '<span class="inserter badge ' + extra_class + ' ">' + table_name + '</span> ' + 
	      $.map(table.columnNames, function(col) { return '<span class="inserter">' + col + '</span>' }).join(', ') 
	      + "<br>"
	    var $table = $(html)
	    $('#meta').append($table)
	  })
	  var lastCursorPosition = -1
	  editor.on('change', function() {
	    lastCursorPosition = -1
	  })
	  $('.inserter').click(function() {
	    if (JSON.stringify(lastCursorPosition) == JSON.stringify(editor.getCursorPosition())) {
	      editor.insert(', ')
	    }
	    editor.insert($(this).text())
            editor.focus()
	    lastCursorPosition = editor.getCursorPosition()
	  })
	}, function (jqXHR, textStatus, errorThrown) { scraperwiki.alert("Error getting schema:", textStatus) } )
    })
    </script>

  </body>
</html>


