<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Code your own SQL!</title>
    <link rel="stylesheet" href="http://x.scraperwiki.com/vendor/style/bootstrap.min.css">
    <link rel="stylesheet" href="http://x.scraperwiki.com/vendor/style/metro.bootstrap.css">
    <style type="text/css">
	body {
        padding: 20px;
        height: 100%;
	}
	html {
        height: 100%;
	}
    #editor { 
        width: 100%;
        height: 35%;
    }
    #output { 
        width: 100%;
        height: 55%;
    }

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="https://x.scraperwiki.com/js/scraperwiki.js"></script>
    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
  </head>
  <body>

   <div id="editor"></div>

   <form id="tw" action="#" method="POST" enctype="multipart/form-data">
      <input type="button" value="Query!" id="run">
      <br>
    </form>

   <div id="output"></div>

   <script>
   $(document).ready(function() {
        var editor
        scraperwiki.exec('mkdir -p code; touch code/query.sql; cat code/query.sql', function(data) {
          editor = ace.edit("editor")
          editor.setValue(data)
          editor.setTheme("ace/theme/monokai")
          editor.getSession().setMode("ace/mode/sql")
          editor.clearSelection()
          editor.focus()
        })

        var output = ace.edit("output")
        output.setTheme("ace/theme/monokai")
        output.getSession().setMode("ace/mode/json")

        $('#run').on('click', function() {
          var code = editor.getValue();
          var cmd = "mkdir -p code; cat >code/query.sql.$$.new <<ENDOFSCRAPER\n" + code + "\nENDOFSCRAPER\n"
          cmd = cmd + "mv code/query.sql.$$.new code/query.sql"
	  scraperwiki.exec(cmd, function () {
	    scraperwiki.sql(code, function (response) {
		output.setValue(JSON.stringify(response, null, 4))
		output.clearSelection()
	    }, function (response) {
		output.setValue(JSON.stringify(response, null, 4))
		output.clearSelection()
	    })
	 })
        })
    })
    </script>

  </body>
</html>


